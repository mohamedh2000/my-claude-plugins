---
description: File-based planning with parallel sub-agent execution
argument-hint: Optional task description
---

# Planning with Files (Parallel Edition)

Fork of planning-with-files with support for **parallel sub-agent execution**.

## Core Concept

```
Context Window = RAM (volatile, limited)
Filesystem = Disk (persistent, unlimited)
→ Anything important gets written to disk.
```

## The Three-File Memory Architecture

| File | Purpose | When to Update |
|------|---------|----------------|
| `task_plan.md` | Tasks, groups, progress, decisions | After each task/group |
| `findings.md` | Research, discoveries, decisions | After ANY discovery |
| `progress.md` | Session log, test results | Throughout session |

---

## PARALLEL EXECUTION PROTOCOL

This fork adds memory-safe parallel execution for tasks generated by `/prd`.

### When to Use Parallel Execution

Use parallel execution when task_plan.md contains:
- `## Execution Groups` table with multiple tasks per group
- Tasks marked with `**Group:** N`
- Multiple tasks with no dependencies between them

### Memory Architecture for Parallel Agents

To avoid race conditions, each sub-agent gets **isolated memory files**:

```
SHARED FILES (sub-agents READ only):
├── task_plan.md          ← Orchestrator owns
├── findings.md           ← Context for sub-agents
├── progress.md           ← Context for sub-agents
└── .claude/Task Documents/PRD-*.md

ISOLATED FILES (each sub-agent WRITES to their own):
├── findings_[TASK-ID].md    ← Agent's discoveries
└── progress_[TASK-ID].md    ← Agent's session log
```

### Parallel Execution Flow

**1. DETECT** - Read task_plan.md, find the current Execution Group

**2. SPAWN** - For each task in the parallel group:
- Use Task tool with appropriate agent type
- ALL tasks in group spawn in a SINGLE message (true parallel)
- Each agent gets their isolated file names

**3. EXECUTE** - Each sub-agent:
- READS: task_plan.md, findings.md, progress.md, PRD
- WRITES: findings_[TASK-ID].md, progress_[TASK-ID].md
- DOES NOT MODIFY: shared files

**4. MERGE** - After ALL agents complete:
- Read all findings_[TASK-ID].md from the group
- Append to findings.md under `## [TASK-ID] Findings`
- Read all progress_[TASK-ID].md from the group
- Append to progress.md
- Update task_plan.md statuses
- Delete sub-agent files (cleanup)

**5. CONTINUE** - Proceed to next group

### Sub-Agent Prompt Template

For EACH parallel task, spawn with:

```
You are executing [TASK-ID]: [Task Title] for [feature-name].

CONTEXT (read first, DO NOT modify):
- task_plan.md → Find your task under [TASK-ID]
- findings.md → Decisions and rationale from discovery
- .claude/Task Documents/PRD-[name].md → Full requirements
- .claude/CODEBASE_ARCHITECTURE.md → Codebase patterns

YOUR ISOLATED MEMORY FILES (create and update throughout):
- findings_[TASK-ID].md → Your discoveries, decisions, technical notes
- progress_[TASK-ID].md → Your session log: actions, files modified, errors

EXECUTE:
Complete all subtasks for [TASK-ID] listed in task_plan.md.

WHEN COMPLETE:
Return summary: files created/modified, status (complete/blocked), any blockers.
```

### Post-Group Merge Checklist

After ALL agents in a parallel group complete:

- [ ] Collect all findings_[TASK-ID].md files from the group
- [ ] Append each to findings.md under appropriate headers
- [ ] Collect all progress_[TASK-ID].md files from the group
- [ ] Append each to progress.md
- [ ] Update task_plan.md: Mark all group tasks as complete
- [ ] Log any errors to Errors Encountered table
- [ ] Delete all sub-agent isolated files
- [ ] Check if next group is unblocked, proceed accordingly

---

## Sequential Execution (Non-Parallel Tasks)

For tasks NOT in a parallel group, execute normally:

1. Read task_plan.md to identify current task
2. Execute the task directly (no sub-agent needed)
3. Update findings.md with discoveries
4. Update progress.md with actions taken
5. Mark task complete in task_plan.md
6. Proceed to next task

---

## Critical Rules

### 1. Read Before Decide
Before major decisions, read task_plan.md. Keeps goals in attention window.

### 2. The 2-Action Rule
> "After every 2 view/browser/search operations, IMMEDIATELY save to findings.md"

### 3. Never Repeat Failures
```
if action_failed:
    next_action != same_action
```
Track what you tried. Mutate the approach.

### 4. Log ALL Errors
Every error goes in task_plan.md AND progress.md.

### 5. Single Writer for Shared Files
During parallel execution, ONLY orchestrator writes to:
- task_plan.md
- findings.md (via merge)
- progress.md (via merge)

---

## The 3-Strike Error Protocol

```
ATTEMPT 1: Diagnose & Fix
  → Read error carefully
  → Identify root cause
  → Apply targeted fix

ATTEMPT 2: Alternative Approach
  → Same error? Try different method
  → NEVER repeat exact same failing action

ATTEMPT 3: Broader Rethink
  → Question assumptions
  → Search for solutions

AFTER 3 FAILURES: Escalate to User
  → Explain what you tried
  → Share the specific error
  → Ask for guidance
```

---

## The 5-Question Reboot Test

If you can answer these, context is solid:

| Question | Answer Source |
|----------|---------------|
| Where am I? | Current group/task in task_plan.md |
| Where am I going? | Remaining groups/tasks |
| What's the goal? | Goal statement in task_plan.md |
| What have I learned? | findings.md |
| What have I done? | progress.md |

---

## Templates

Use templates from `${CLAUDE_PLUGIN_ROOT}/templates/`:
- `task_plan.md` — Task tracking with parallel groups
- `findings.md` — Research storage
- `progress.md` — Session logging

## Scripts

- `${CLAUDE_PLUGIN_ROOT}/scripts/check-complete.sh` — Verify all tasks complete

---

## Integration with /prd

This skill is designed to work with `/prd`:

1. `/prd` generates PRD with task breakdown
2. `/prd` generates task_plan.md with Execution Groups
3. `/planning-parallel` executes the plan
4. Parallel groups spawn sub-agents
5. Sequential tasks execute directly

```
/spawn feature-name
    ↓
/prd (auto-started)
    ↓
/planning-parallel
    ├── Group 1: Spawn BE-001, BE-002, FE-001 in parallel
    ├── Merge results
    ├── Group 2: Spawn dependent tasks
    ├── Merge results
    └── Sequential: Testing, Delivery
```
